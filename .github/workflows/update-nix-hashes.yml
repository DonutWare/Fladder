name: Update Nix Hashes

on:
  push:
    paths:
      - 'pubspec.lock'
      - 'pubspec.yaml'
  workflow_dispatch:

jobs:
  update-hashes:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v6.0.1
      
      - name: Install Nix
        uses: cachix/install-nix-action@v31.9.0
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      - name: Update Nix Hashes
        run: |
          FLAKE_FILE="flake.nix"
          LOCK_FILE="pubspec.lock"

          # 1. Update media_kit hash
          echo "Checking media_kit..."
          MEDIA_KIT_REF=$(grep -A 15 "media_kit:" "$LOCK_FILE" | grep "resolved-ref:" | head -n 1 | awk '{print $2}')

          if [ -n "$MEDIA_KIT_REF" ]; then
            echo "Found media_kit ref: $MEDIA_KIT_REF"
            
            # Calculate the Nix hash using nix-prefetch-git
            HASH_JSON=$(nix-shell -p nix-prefetch-git --run "nix-prefetch-git https://github.com/DonutWare/media-kit.git --rev $MEDIA_KIT_REF")
            MEDIA_KIT_HASH=$(echo "$HASH_JSON" | grep '"hash":' | cut -d'"' -f4)
            
            if [ -n "$MEDIA_KIT_HASH" ]; then
              echo "Calculated media_kit hash: $MEDIA_KIT_HASH"
              sed -i "s/media_kit-hash = \".*\";/media_kit-hash = \"$MEDIA_KIT_HASH\";/" "$FLAKE_FILE"
            fi
          fi

          # 2. Update fvp version and hash
          echo "Checking fvp..."
          FVP_VERSION=$(grep -A 10 "fvp:" "$LOCK_FILE" | grep "version:" | head -n 1 | awk '{print $2}' | tr -d '"')

          if [ -n "$FVP_VERSION" ]; then
            echo "Found fvp version: $FVP_VERSION"
            FVP_URL="https://github.com/wang-bin/mdk-sdk/releases/download/v${FVP_VERSION}/mdk-sdk-linux-x64.tar.xz"
            FVP_HASH_RAW=$(nix-prefetch-url "$FVP_URL")
            FVP_HASH=$(nix hash to-sri --type sha256 "$FVP_HASH_RAW")
            
            if [ -n "$FVP_HASH" ]; then
              echo "Calculated fvp hash: $FVP_HASH"
              sed -i "s/fvpVersion = \".*\";/fvpVersion = \"$FVP_VERSION\";/" "$FLAKE_FILE"
              sed -i "s/fvpHash = \".*\";/fvpHash = \"$FVP_HASH\";/" "$FLAKE_FILE"
            fi
          fi

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v8.0.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore(nix): update media_kit and fvp hashes"
          committer: GitHub <noreply@github.com>
          author: github-actions[bot] <41898282+github-actions[bot]@users.noreply.github.com>
          signoff: false
          branch: nix-hash-update
          delete-branch: true
          title: "chore(nix): update media_kit and fvp hashes"
          body: |
            Automated update of Nix hashes in `flake.nix` based on changes in `pubspec.lock`.
            
            - Updated `media_kit` hash
            - Updated `fvp` version and hash
