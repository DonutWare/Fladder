name: Update Nix Hashes

on:
  push:
    paths:
      - 'pubspec.lock'
      - 'pubspec.yaml'
  workflow_dispatch:

jobs:
  update-hashes:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v6.0.1
      
      - name: Install Nix
        uses: cachix/install-nix-action@v31.9.0
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      - name: Update Nix Hashes
        run: |
          FLAKE_FILE="flake.nix"
          LOCK_FILE="pubspec.lock"
          CHANGES_MADE=false

          # 1. Update media_kit hash
          echo "Checking media_kit..."
          MEDIA_KIT_REF=$(grep -A 15 "media_kit:" "$LOCK_FILE" | grep "resolved-ref:" | head -n 1 | awk '{print $2}')

          if [ -n "$MEDIA_KIT_REF" ]; then
            echo "Found media_kit ref: $MEDIA_KIT_REF"
            CURRENT_HASH=$(grep 'media_kit-hash = ' "$FLAKE_FILE" | head -n 1 | awk -F'"' '{print $2}')
            
            # Calculate the Nix hash using nix-prefetch-git
            HASH_JSON=$(nix-shell -p nix-prefetch-git --run "nix-prefetch-git https://github.com/DonutWare/media-kit.git --rev $MEDIA_KIT_REF")
            MEDIA_KIT_HASH=$(echo "$HASH_JSON" | grep '"hash":' | cut -d'"' -f4)
            
            if [ -n "$MEDIA_KIT_HASH" ]; then
              echo "Calculated media_kit hash: $MEDIA_KIT_HASH"
              if [ "$CURRENT_HASH" != "$MEDIA_KIT_HASH" ]; then
                echo "media_kit hash changed from $CURRENT_HASH to $MEDIA_KIT_HASH"
                sed -i "s/media_kit-hash = \".*\";/media_kit-hash = \"$MEDIA_KIT_HASH\";/" "$FLAKE_FILE"
                CHANGES_MADE=true
              else
                echo "media_kit hash unchanged"
              fi
            fi
          fi

          # Exit with status to indicate if changes were made
          if [ "$CHANGES_MADE" = true ]; then
            echo "Changes detected"
            exit 0
          else
            echo "No changes detected"
            exit 1
          fi

      - name: Create Pull Request
        if: success()
        uses: peter-evans/create-pull-request@v8.0.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore(nix): update media_kit and fvp hashes"
          committer: GitHub <noreply@github.com>
          author: github-actions[bot] <41898282+github-actions[bot]@users.noreply.github.com>
          signoff: false
          branch: nix-hash-update
          delete-branch: true
          title: "chore(nix): update media_kit and fvp hashes"
          body: |
            Automated update of Nix hashes in `flake.nix` based on changes in `pubspec.lock`.
            
            - Updated `media_kit` hash
